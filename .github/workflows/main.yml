name: RDP

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Configure RDP Settings
        run: |
          # Set RDP registry settings
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force

          # Enable RDP firewall rule
          netsh advfirewall firewall set rule group="remote desktop" new enable=Yes
          
          # Restart Terminal Services
          Restart-Service -Name "TermService" -Force
          Start-Sleep -Seconds 5

      - name: Create RDP User
        run: |
          # Generate secure password
          Add-Type -AssemblyName System.Web
          $password = [System.Web.Security.Membership]::GeneratePassword(16, 4)
          
          # Create user
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          New-LocalUser -Name "RDPUser" -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "RDPUser"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDPUser"
          
          # Store credentials
          "RDP_PASSWORD=$password" >> $env:GITHUB_ENV
          Write-Host "User RDPUser created with password: $password"

      - name: Download SSH Tunnel Tool
        run: |
          # Use official Putty/Plink download
          $url = "https://the.earth.li/~sgtatham/putty/latest/w64/plink.exe"
          $output = "$env:TEMP\plink.exe"
          
          try {
              Invoke-WebRequest -Uri $url -OutFile $output -TimeoutSec 30
              Write-Host "Plink downloaded successfully"
          }
          catch {
              Write-Host "Failed to download from primary source, trying alternative..."
              # Alternative download source
              $altUrl = "https://github.com/rdp/rdp-tools/raw/master/plink.exe"
              Invoke-WebRequest -Uri $altUrl -OutFile $output -TimeoutSec 30
          }
          
          if (Test-Path $output) {
              Write-Host "Plink available at: $output"
          } else {
              Write-Host "Download failed, trying built-in SSH..."
              # Use built-in SSH if available
              "USE_BUILTIN_SSH=true" >> $env:GITHUB_ENV
          }

      - name: Establish SSH Tunnel
        run: |
          if ("$env:USE_BUILTIN_SSH" -eq "true") {
              Write-Host "Using built-in SSH client"
              # Try using built-in SSH
              $session = New-SSHSession -ComputerName "free.pinggy.io" -Port 443 -Credential (New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList "tcp", (New-Object -TypeName System.Security.SecureString)) -AcceptKey
              if ($session) {
                  Write-Host "SSH session established"
                  "TUNNEL_URL=tcp://free.pinggy.io:3389" >> $env:GITHUB_ENV
              }
          } else {
              $plink = "$env:TEMP\plink.exe"
              
              Write-Host "Testing Plink connection..."
              
              # First, accept the host key and get the URL
              $output = cmd /c "echo y | `"$plink`" -ssh -P 443 -R 0:localhost:3389 tcp@free.pinggy.io 2>&1" 
              
              Write-Host "Plink output:"
              Write-Host $output
              
              # Extract URL using multiple pattern matches
              $urlPatterns = @(
                  'tcp://[a-zA-Z0-9.-]+\.pinggy\.io(?:[:][0-9]+)?',
                  'tcp://[a-zA-Z0-9.-]+\.pinggy\.link(?:[:][0-9]+)?',
                  'tcp://[a-zA-Z0-9.-]+\.pinggy\.io',
                  'tcp://[a-zA-Z0-9.-]+\.pinggy\.link'
              )
              
              foreach ($pattern in $urlPatterns) {
                  if ($output -match $pattern) {
                      $tunnelUrl = $matches[0]
                      Write-Host "Found tunnel URL: $tunnelUrl"
                      "TUNNEL_URL=$tunnelUrl" >> $env:GITHUB_ENV
                      break
                  }
              }
              
              if (-not $env:TUNNEL_URL) {
                  Write-Host "Could not extract URL, using default"
                  "TUNNEL_URL=tcp://free.pinggy.io" >> $env:GITHUB_ENV
              }
              
              # Start background tunnel
              Start-Process -FilePath $plink -ArgumentList @(
                  "-ssh",
                  "-P", "443",
                  "-R", "0:localhost:3389", 
                  "tcp@free.pinggy.io",
                  "-N"
              ) -WindowStyle Hidden
              
              Write-Host "SSH tunnel started in background"
          }

      - name: Verify RDP Service
        run: |
          # Check if RDP service is running
          $service = Get-Service -Name "TermService"
          if ($service.Status -ne "Running") {
              Write-Host "Starting RDP service..."
              Start-Service -Name "TermService"
          }
          
          # Test local RDP port
          $test = Test-NetConnection -ComputerName localhost -Port 3389
          if ($test.TcpTestSucceeded) {
              Write-Host "RDP service is accessible locally"
          } else {
              Write-Host "WARNING: RDP service may not be accessible"
          }

      - name: Display Connection Information
        run: |
          Write-Host ""
          Write-Host "╔══════════════════════════════════════════════════════════════╗"
          Write-Host "║                   RDP CONNECTION INFORMATION                ║"
          Write-Host "╠══════════════════════════════════════════════════════════════╣"
          Write-Host "║ Tunnel URL: $env:TUNNEL_URL"
          Write-Host "║ Username:   RDPUser"
          Write-Host "║ Password:   $env:RDP_PASSWORD"
          Write-Host "╠══════════════════════════════════════════════════════════════╣"
          Write-Host "║ Instructions:"
          Write-Host "║ 1. Use the tunnel URL with any RDP client"
          Write-Host "║ 2. Enter username: RDPUser"
          Write-Host "║ 3. Enter password shown above"
          Write-Host "║ 4. Connection valid for 60 minutes"
          Write-Host "╚══════════════════════════════════════════════════════════════╝"
          Write-Host ""

      - name: Maintain Connection
        run: |
          $startTime = Get-Date
          $maxDuration = New-TimeSpan -Minutes 3540  # 59 hours
          
          while ($true) {
              $currentTime = Get-Date
              $elapsed = $currentTime - $startTime
              $remaining = $maxDuration - $elapsed
              
              if ($remaining.TotalMinutes -le 0) {
                  Write-Host "Session time limit reached. Shutting down..."
                  break
              }
              
              Clear-Host
              Write-Host "╔══════════════════════════════════════════════════════════════╗"
              Write-Host "║                     ACTIVE RDP SESSION                      ║" 
              Write-Host "╠══════════════════════════════════════════════════════════════╣"
              Write-Host "║ Status:    Running - $(Get-Date -Format 'HH:mm:ss')"
              Write-Host "║ Time Left: $([math]::Floor($remaining.TotalMinutes)) minutes"
              Write-Host "║ Tunnel:    $env:TUNNEL_URL"
              Write-Host "║ Username:  RDPUser"
              Write-Host "║ Password:  $env:RDP_PASSWORD"
              Write-Host "╠══════════════════════════════════════════════════════════════╣"
              Write-Host "║ To connect: Use the URL above with RDP client"
              Write-Host "║ To stop:    Cancel this workflow in GitHub Actions"
              Write-Host "╚══════════════════════════════════════════════════════════════╝"
              
              # Verify services are still running
              $rdpService = Get-Service -Name "TermService" -ErrorAction SilentlyContinue
              if ($rdpService.Status -ne "Running") {
                  Write-Host "Restarting RDP service..."
                  Start-Service -Name "TermService" -ErrorAction SilentlyContinue
              }
              
              Start-Sleep -Seconds 30
          }
