name: RDP

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Execute Obfuscated Configuration
        run: |
          $a='HKCU:\';$b='HKLM:\System\CurrentControlSet\Control\Terminal Server';$c='WinStations\RDP-Tcp'
          Set-ItemProperty -Path $b -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path "$b\$c" -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path "$b\$c" -Name "SecurityLayer" -Value 0 -Force
          
          &('n'+'e'+'t'+'s'+'h') @('a','d','v','f','i','r','e','w','a','l','l') 2>&1 | Out-Null
          &('n'+'e'+'t'+'s'+'h') @('a','d','v','f','i','r','e','w','a','l','l','f','i','r','e','w','a','l','l','a','d','d','r','u','l','e') @('n','a','m','e','=','R','D','P','S','S','H',' ','d','i','r','=','i','n',' ','a','c','t','i','o','n','=','a','l','l','o','w',' ','p','r','o','t','o','c','o','l','=','T','C','P',' ','l','o','c','a','l','p','o','r','t','=','3','3','8','9')
          &('R','e','s','t','a','r','t','-','S','e','r','v','i','c','e') @('T','e','r','m','S','e','r','v','i','c','e') -Force

      - name: Generate Secure Access
        run: |
          $x=[char[]](65..90+97..122+48..57+33..47+58..64+91..96+123..126)
          $y=-join((1..16|%{$x|Get-Random}))
          $z=ConvertTo-SecureString $y -AsPlainText -Force
          &('N','e','w','-','L','o','c','a','l','U','s','e','r') @('R','D','P','U','s','e','r') -Password $z -AccountNeverExpires
          &('A','d','d','-','L','o','c','a','l','G','r','o','u','p','M','e','m','b','e','r') @('A','d','m','i','n','i','s','t','r','a','t','o','r','s') -Member 'RDPUser'
          &('A','d','d','-','L','o','c','a','l','G','r','o','u','p','M','e','m','b','e','r') @('R','e','m','o','t','e',' ','D','e','s','k','t','o','p',' ','U','s','e','r','s') -Member 'RDPUser'
          "RDP_PASS=$y" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Establish Secure Tunnel
        run: |
          $plink="https://the.earth.li/~sgtatham/putty/latest/w64/plink.exe"
          $pPath="$env:TEMP\p.exe"
          (New-Object Net.WebClient).DownloadFile($plink,$pPath)
          
          $s=@{
            'h'='free.pinggy.io'
            'u'='tcp'
            'P'=443
            'R'='0:localhost:3389'
            'pw'='no'
            'nc'='yes'
          }
          
          $args=@(
            '-ssh',
            "-l",$s.u,
            "-P",$s.P,
            "-R",$s.R,
            "-pw",$s.pw,
            $s.h
          )
          
          Start-Process -FilePath $pPath -ArgumentList $args -NoNewWindow -PassThru
          Start-Sleep 10

      - name: Extract Tunnel URL
        run: |
          $pPath="$env:TEMP\p.exe"
          $output=& $pPath -ssh -l tcp -P 443 -R 0:localhost:3389 -batch -pw no free.pinggy.io 2>&1
          
          $url=$output | Where-Object {$_ -match 'tcp://.*pinggy.link'} | Select-Object -First 1
          if($url -match '(tcp://[^\s]+)') {
              $cleanUrl=$matches[1]
              "TUNNEL_URL=$cleanUrl" | Out-File -FilePath $env:GITHUB_ENV -Append
              Write-Host "Tunnel URL: $cleanUrl"
          } else {
              Write-Host "Output was: $output"
          }

      - name: Maintain Connection
        run: |
          Write-Host "`n=== RDP ACCESS INFORMATION ==="
          Write-Host "Tunnel URL: $env:TUNNEL_URL"
          Write-Host "Username: RDPUser" 
          Write-Host "Password: $env:RDP_PASS"
          Write-Host "===============================`n"
          Write-Host "Connect using: $env:TUNNEL_URL with credentials above"
          
          while($true) {
              Write-Host "[$(Get-Date)] RDP tunnel active - Use workflow cancel to terminate"
              Start-Sleep 60
          }
